<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialHub 7.5 - منصة احترافية متكاملة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Facebook SDK -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    
    <!-- Custom Styles & Tailwind Config -->
    <style>
        :root { 
            --primary-color: #4f46e5; --primary-light: #6366f1; --primary-dark: #4338ca;
        }
        * { font-family: 'Tajawal', sans-serif; scroll-behavior: smooth; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dragging { opacity: 0.5; border: 2px dashed var(--primary-color); transform: scale(1.05); }
        .drag-over { background-color: rgba(79, 70, 229, 0.1); }
        .btn-primary { background-color: var(--primary-color); color: white; padding: .65rem 1.25rem; border-radius: .5rem; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger { background-color: #ef4444; color: white; padding: .5rem 1rem; border-radius: .5rem; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .form-input, .form-select, .form-textarea, .form-checkbox { border:1px solid #d1d5db; border-radius:.5rem; transition: all .2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); outline: none; }
        .dark .form-input, .dark .form-select, .dark .form-textarea, .dark .form-checkbox { background-color:#374151; color:#d1d5db; border-color:#4b5563; }
        .form-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .platform-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .pagination { display: flex; justify-content: center; margin-top: 1.5rem; }
        .pagination button { margin: 0 0.25rem; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: white; }
        .pagination button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .virtual-list { overflow-y: auto; }
        .virtual-item { position: absolute; width: 100%; }
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-full { width: 100% !important; }
            .mobile-stack { flex-direction: column; }
            .mobile-text-center { text-align: center; }
            .mobile-p-2 { padding: 0.5rem; }
            .header-buttons { flex-wrap: wrap; justify-content: center; }
            .sidebar { width: 100% !important; transform: translateX(100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 29; display: none; }
            .sidebar-overlay.open { display: block; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .accessibility-outline:focus {
            outline: 2px solid var(--primary-light);
            outline-offset: 2px;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#4f46e5', light: '#6366f1', dark: '#4338ca' },
                        dark: { 'bg': '#111827', 'card': '#1f2937', 'border': '#374151', 'text': '#d1d5db', 'text-secondary': '#9ca3af' },
                        facebook: '#1877F2', instagram: '#E4405F', telegram: '#2AABEE', whatsapp: '#25D366', rss: '#f26522',
                        twitter: '#1DA1F2', linkedin: '#0A66C2', youtube: '#FF0000', tiktok: '#000000'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-800 dark:text-dark-text transition-all">
    
    <!-- Global Elements -->
    <div id="loaderOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden"><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary-light"></div></div>
    <div id="toast-container" class="fixed bottom-5 end-5 z-[90] space-y-2 w-full max-w-xs"></div>
    <div id="mainModal" class="fixed inset-0 z-[80] hidden bg-black bg-opacity-60 overflow-y-auto h-full w-full flex items-center justify-center p-4">
        <div id="mainModalContent" class="bg-white dark:bg-dark-card rounded-2xl shadow-xl w-full max-w-lg transition-transform transform scale-95"></div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Login Page -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-dark-bg p-4">
        <div class="w-full max-w-md bg-white dark:bg-dark-card shadow-2xl rounded-2xl p-8">
            <div class="text-center mb-6"><h2 class="text-3xl font-bold flex items-center justify-center text-primary-dark dark:text-primary-light"><i class="fa-solid fa-rocket mr-2"></i>SocialHub</h2><p class="text-gray-500 dark:text-dark-text-secondary mt-2">الإصدار 7.5: منصة احترافية متكاملة وجاهزة للإطلاق.</p></div>
            <button id="googleLoginBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-all"><i class="fab fa-google mr-2"></i> تسجيل الدخول باستخدام جوجل</button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="appContainer" class="hidden">
        <!-- Mobile Header -->
        <header class="md:hidden fixed top-0 left-0 right-0 bg-white/80 dark:bg-dark-card/80 backdrop-blur-sm border-b border-gray-200 dark:border-dark-border h-16 flex items-center justify-between px-4 z-40">
            <button id="mobileMenuBtn" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 dark:bg-dark-bg text-gray-600 dark:text-gray-300">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 id="mobilePageTitle" class="text-xl font-bold text-gray-900 dark:text-white">لوحة التحكم</h1>
            <div class="w-10 h-10"></div> <!-- Spacer for balance -->
        </header>

        <aside id="sidebar" class="fixed top-0 right-0 h-full bg-white dark:bg-dark-card border-l border-gray-200 dark:border-dark-border z-30 transition-all w-20 hover:w-64 group hide-scrollbar overflow-y-auto sidebar">
            <div class="h-20 flex items-center justify-center px-4"><a href="#" data-section="dashboard" class="flex items-center text-decoration-none"><i class="fa-solid fa-rocket text-3xl text-primary"></i><span class="sidebar-brand-text font-bold text-2xl mr-2 text-gray-800 dark:text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">SocialHub</span></a></div>
            <nav class="mt-4">
                <a class="nav-link active" href="#" data-section="dashboard"><i class="icon fa-solid fa-home"></i><span class="text">لوحة التحكم</span></a>
                <a class="nav-link" href="#" data-section="automations"><i class="icon fa-solid fa-robot"></i><span class="text">التحكم الآلي</span></a>
                <a class="nav-link" href="#" data-section="publishing"><i class="icon fa-solid fa-calendar-alt"></i><span class="text">تقويم النشر</span></a>
                <a class="nav-link" href="#" data-section="creator"><i class="icon fa-solid fa-pencil"></i><span class="text">إنشاء منشور</span></a>
                <a class="nav-link" href="#" data-section="analytics"><i class="icon fa-solid fa-chart-line"></i><span class="text">التحليلات</span></a>
                <a class="nav-link" href="#" data-section="inbox"><i class="icon fa-solid fa-inbox"></i><span class="text">صندوق الوارد</span><span id="inbox-unread-badge" class="mr-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span></a>
                <a class="nav-link" href="#" data-section="bulk-import"><i class="icon fa-solid fa-file-upload"></i><span class="text">استيراد جماعي</span></a>
                <a class="nav-link" href="#" data-section="accounts"><i class="icon fa-solid fa-link"></i><span class="text">إدارة الحسابات</span></a>
                <a id="admin-nav-link" class="nav-link hidden" href="#" data-section="admin"><i class="icon fa-solid fa-user-shield"></i><span class="text">لوحة المسؤول</span></a>
            </nav>
            <div class="absolute bottom-0 w-full">
                <a class="nav-link" href="#" data-section="settings"><i class="icon fa-solid fa-cog"></i><span class="text">الإعدادات</span></a>
                <a class="nav-link" href="#" id="logoutBtn"><i class="icon fa-solid fa-sign-out-alt"></i><span class="text">تسجيل الخروج</span></a>
            </div>
            <style>
                .nav-link{display:flex;align-items:center;color:#4b5563;padding:1rem;transition:all .2s}.nav-link:hover,.nav-link.active{background-color:#f3f4f6;color:var(--primary-color)}.dark .nav-link{color:#9ca3af}.dark .nav-link:hover,.dark .nav-link.active{background-color:#1f2937;color:var(--primary-light)}.nav-link .icon{width:2rem;text-align:center;font-size:1.5rem}.nav-link .text{margin-right:1rem;font-size:1.1rem;opacity:0;transition:opacity .2s;white-space:nowrap}.group:hover .nav-link .text{opacity:1}
            </style>
        </aside>

        <div class="md:pr-20 pt-16 md:pt-0">
            <header class="fixed top-0 left-0 right-20 bg-white/80 dark:bg-dark-card/80 backdrop-blur-sm border-b border-gray-200 dark:border-dark-border h-20 md:flex items-center justify-between px-8 z-20 hidden">
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-900 dark:text-white">لوحة التحكم</h1>
                <div class="flex items-center space-x-4 header-buttons">
                    <button id="themeSwitch" class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100 dark:bg-dark-bg text-gray-600 dark:text-yellow-400 accessibility-outline"><i class="fas fa-moon text-xl"></i></button>
                    <div class="relative" id="user-menu-container"><button id="user-menu-button" class="flex items-center space-x-2 accessibility-outline"><img id="userAvatar" src="" class="w-12 h-12 rounded-full" alt="User"><span id="userNameDisplay" class="hidden md:block font-semibold"></span><i class="fas fa-chevron-down hidden md:block text-xs"></i></button><div id="user-menu" class="absolute left-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-md shadow-lg py-1 z-20 hidden"><a href="#" data-section="settings" class="block px-4 py-2 text-sm text-gray-700 dark:text-dark-text hover:bg-gray-100 dark:hover:bg-dark-bg">الملف الشخصي</a><a href="#" id="logoutBtnDropdown" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-dark-bg">تسجيل الخروج</a></div></div>
                </div>
            </header>

            <main id="mainContent" class="pt-4 md:pt-28 pb-8 px-4 md:px-8">
                <!-- Sections will be rendered here -->
            </main>
        </div>
    </div>
    
    <script type="module">
        // ===================================================================================
        // V7.5 - SocialHub - Professional Version with Enhanced Features
        // Author: Gemini & DeepSeek
        // Description: A fully functional social media management tool with enhanced security,
        //              performance optimizations, and professional backend simulation.
        // ===================================================================================

        // ===== 1. FIREBASE & LIBRARIES CONFIG =====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, onSnapshot, serverTimestamp, Timestamp, writeBatch, deleteDoc, getDocs, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { subDays, format, getDaysInMonth, toDate, parse, startOfDay, endOfDay, getDay } from 'https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDexampleAPIKeyForFirebaseConfig",
            authDomain: "socialhub-7-5.firebaseapp.com",
            projectId: "socialhub-7-5",
            storageBucket: "socialhub-7-5.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcd1234exampleappid"
        };
        
        const appId = 'socialhub-prod-v7-5';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ===== 2. GLOBAL STATE & CONFIG =====
        let currentUserData, userId, userAccounts = [], userAutomations = [], allConversations = [];
        let charts = {};
        let unsubscribeListeners = [];
        let calendarDate = new Date();
        const POST_CHECK_INTERVAL = 60000; // 1 minute
        let postCheckIntervalId = null;
        
        // Pagination state
        let postsPagination = {
            currentPage: 1,
            pageSize: 10,
            totalPosts: 0,
            lastVisible: null,
            firstVisible: null
        };
        
        // Virtual list state
        let virtualListState = {
            visibleStartIndex: 0,
            visibleEndIndex: 0,
            itemHeight: 60,
            containerHeight: 0
        };

        const SECTIONS = {
            dashboard: { title: 'لوحة التحكم', renderer: renderDashboard },
            automations: { title: 'التحكم الآلي', renderer: renderAutomations },
            publishing: { title: 'تقويم النشر', renderer: renderCalendar },
            creator: { title: 'إنشاء منشور', renderer: renderCreator },
            analytics: { title: 'التحليلات', renderer: renderAnalytics },
            inbox: { title: 'صندوق الوارد', renderer: renderInbox },
            'bulk-import': { title: 'استيراد جماعي', renderer: renderBulkImport },
            accounts: { title: 'إدارة الحسابات', renderer: renderAccountsManagement },
            settings: { title: 'الإعدادات', renderer: renderSettings },
            admin: { title: 'لوحة المسؤول', renderer: renderAdminPanel }
        };

        // ===== 3. CORE UI & NAVIGATION =====
        function setupSections() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '';
            Object.keys(SECTIONS).forEach(key => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                sectionDiv.id = `${key}Section`;
                mainContent.appendChild(sectionDiv);
            });
        }
        
        function navigateToSection(sectionId, params = {}) {
            try {
                if (!SECTIONS[sectionId]) { 
                    console.error(`Section "${sectionId}" not found.`); 
                    return; 
                }
                
                // Clear all existing listeners and charts
                unsubscribeAllListeners();
                destroyAllCharts();
                
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(`${sectionId}Section`)?.classList.add('active');
                document.querySelectorAll('#sidebar a').forEach(l => l.classList.remove('active'));
                document.querySelector(`#sidebar a[data-section="${sectionId}"]`)?.classList.add('active');
                
                // Update page titles for both desktop and mobile
                document.getElementById('pageTitle').textContent = SECTIONS[sectionId].title;
                document.getElementById('mobilePageTitle').textContent = SECTIONS[sectionId].title;
                
                // Close mobile sidebar if open
                closeMobileSidebar();
                
                // Render the section
                SECTIONS[sectionId].renderer(params);
            } catch (error) {
                console.error("Error navigating to section:", error);
                showToast('خطأ', 'حدث خطأ أثناء تحميل الصفحة.', 'error');
            }
        }
        
        // ===== 4. SECTION RENDERERS (Updated & Enhanced) =====
        
        function renderDashboard() {
            try {
                const container = document.getElementById('dashboardSection');
                // Use shimmer loading while data is being fetched
                container.innerHTML = `
                    <div class="mb-6 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                        <div class="h-8 loading-shimmer w-1/2 mb-2"></div>
                        <div class="h-4 loading-shimmer w-3/4"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-8">
                        ${Array(5).fill().map(() => `
                            <div class="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-md flex items-center">
                                <div class="w-12 h-12 rounded-full loading-shimmer"></div>
                                <div class="mr-4">
                                    <div class="h-4 loading-shimmer w-20 mb-2"></div>
                                    <div class="h-6 loading-shimmer w-16"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                            <div class="h-6 loading-shimmer w-1/3 mb-4"></div>
                            <div class="h-64 loading-shimmer"></div>
                        </div>
                        <div class="lg:col-span-2 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                            <div class="h-6 loading-shimmer w-1/3 mb-4"></div>
                            <div class="space-y-3">
                                ${Array(3).fill().map(() => `
                                    <div class="p-3 bg-gray-50 dark:bg-dark-bg rounded-lg">
                                        <div class="h-4 loading-shimmer w-3/4 mb-2"></div>
                                        <div class="h-3 loading-shimmer w-1/2"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
                
                // Fetch posts with pagination
                fetchPostsWithPagination(1, 50).then(allUserPosts => {
                    const stats = {
                        total: allUserPosts.length,
                        published: allUserPosts.filter(p => p.status === 'published').length,
                        scheduled: allUserPosts.filter(p => p.status === 'scheduled').length,
                        failed: allUserPosts.filter(p => p.status === 'failed').length,
                        engagement: allUserPosts.filter(p => p.status === 'published').reduce((sum, p) => sum + (p.likes || 0) + (p.commentsCount || 0), 0)
                    };
                    
                    container.innerHTML = `
                        <div class="mb-6 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                            <h2 id="greeting-message" class="text-2xl font-bold"></h2>
                            <p id="greeting-subtitle" class="text-gray-600 dark:text-dark-text-secondary mt-2"></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-8">
                            ${createStatCard('إجمالي المنشورات', stats.total, 'fa-file-alt', 'blue')}
                            ${createStatCard('تم النشر', stats.published, 'fa-check-circle', 'green')}
                            ${createStatCard('مجدولة', stats.scheduled, 'fa-calendar-check', 'yellow')}
                            ${createStatCard('فشل النشر', stats.failed, 'fa-exclamation-triangle', 'red')}
                            ${createStatCard('مجموع التفاعل', stats.engagement.toLocaleString('ar'), 'fa-heart', 'purple')}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-3 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                                <h3 class="text-xl font-bold mb-4">أداء التفاعل (آخر 30 يوم)</h3>
                                <canvas id="engagementTrendChart" aria-label="مخطط أداء التفاعل على مدى 30 يوم" role="img"></canvas>
                            </div>
                            <div class="lg:col-span-2 bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md">
                                <h3 class="text-xl font-bold mb-4">المنشورات القادمة</h3>
                                <div id="upcoming-posts-list" class="space-y-3 overflow-y-auto max-h-80"></div>
                            </div>
                        </div>`;
                    
                    renderWelcomeMessage();
                    renderEngagementTrendChart(30);
                    renderUpcomingPosts();
                }).catch(error => {
                    console.error("Error loading dashboard data:", error);
                    showToast('خطأ', 'فشل تحميل بيانات لوحة التحكم.', 'error');
                });
            } catch (error) {
                console.error("Error rendering dashboard:", error);
                showToast('خطأ', 'حدث خطأ أثناء تحميل لوحة التحكم.', 'error');
            }
        }

        // ===== 5. NEW FEATURES & ENHANCEMENTS =====
        
        // 5.1 Cron Job System (Replaces Cloud Functions)
        function setupCronJobSystem() {
            // Register service worker for background tasks
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                    
                    // Setup periodic sync for scheduled posts (requires HTTPS)
                    if ('periodicSync' in registration) {
                        const status = await navigator.permissions.query({
                            name: 'periodic-background-sync',
                        });
                        
                        if (status.state === 'granted') {
                            try {
                                await registration.periodicSync.register('publish-scheduled-posts', {
                                    minInterval: 5 * 60 * 1000, // 5 minutes
                                });
                                console.log('Periodic sync registered');
                            } catch (e) {
                                console.log('Periodic sync could not be registered', e);
                            }
                        }
                    }
                }).catch(error => {
                    console.log('Service Worker registration failed:', error);
                    // Fallback to setInterval if service workers aren't supported
                    startPostScheduler();
                });
            } else {
                // Fallback to setInterval if service workers aren't supported
                startPostScheduler();
            }
            
            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'POST_PUBLISHED') {
                    showToast('نظام النشر', `${event.data.count} منشور(ات) تم نشرها تلقائياً.`, 'info');
                }
            });
        }
        
        // 5.2 Enhanced Facebook Integration
        async function initEnhancedFacebookIntegration() {
            // Load Facebook SDK
            window.fbAsyncInit = function() {
                FB.init({
                    appId: 'YOUR_FACEBOOK_APP_ID',
                    cookie: true,
                    xfbml: true,
                    version: 'v18.0'
                });
                
                // Check login status on page load
                FB.getLoginStatus(function(response) {
                    if (response.status === 'connected') {
                        // User is logged in and authorized
                        handleFacebookAuth(response);
                    }
                });
            };
            
            // Enhanced Facebook login with additional permissions
            function enhancedFacebookLogin() {
                return new Promise((resolve, reject) => {
                    FB.login(function(response) {
                        if (response.status === 'connected') {
                            handleFacebookAuth(response).then(resolve).catch(reject);
                        } else {
                            reject(new Error('User cancelled login or did not fully authorize.'));
                        }
                    }, {
                        scope: 'pages_manage_posts,pages_read_engagement,instagram_basic,instagram_content_publish,business_management',
                        auth_type: 'rerequest',
                        return_scopes: true
                    });
                });
            }
            
            // Improved token management with refresh capability
            async function handleFacebookTokenRefresh(accountId) {
                try {
                    const accountRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, accountId);
                    const accountDoc = await getDoc(accountRef);
                    
                    if (accountDoc.exists()) {
                        const accountData = accountDoc.data();
                        const tokenExpiration = accountData.tokenExpiration || 0;
                        
                        // Refresh token if it expires in less than 24 hours
                        if (tokenExpiration < Date.now() + 24 * 60 * 60 * 1000) {
                            FB.api('/oauth/access_token', {
                                grant_type: 'fb_exchange_token',
                                client_id: 'YOUR_FACEBOOK_APP_ID',
                                client_secret: 'YOUR_FACEBOOK_APP_SECRET',
                                fb_exchange_token: accountData.accessToken
                            }, async (response) => {
                                if (!response.error) {
                                    await updateDoc(accountRef, {
                                        accessToken: response.access_token,
                                        tokenExpiration: Date.now() + response.expires_in * 1000
                                    });
                                    console.log('Facebook token refreshed successfully');
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error refreshing Facebook token:', error);
                }
            }
            
            // Avoid Facebook limitations and blocks
            function applyFacebookRateLimiting() {
                // Implement delay between API calls
                const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                
                // Track API calls to avoid rate limits
                let apiCallCount = 0;
                let lastResetTime = Date.now();
                
                return async function rateLimitedAPICall(apiCall) {
                    const now = Date.now();
                    
                    // Reset counter every minute
                    if (now - lastResetTime > 60000) {
                        apiCallCount = 0;
                        lastResetTime = now;
                    }
                    
                    // If we've made more than 50 calls in a minute, wait
                    if (apiCallCount >= 50) {
                        await delay(60000 - (now - lastResetTime));
                        apiCallCount = 0;
                        lastResetTime = Date.now();
                    }
                    
                    apiCallCount++;
                    await delay(200); // Basic delay between calls
                    
                    return apiCall();
                };
            }
        }
        
        // 5.3 Enhanced Dashboard with Performance Metrics
        function renderEnhancedDashboard() {
            // Add performance metrics to dashboard
            const performanceMetrics = {
                engagementRate: calculateEngagementRate(),
                bestPostingTimes: calculateBestPostingTimes(),
                audienceGrowth: calculateAudienceGrowth(),
                contentPerformance: analyzeContentPerformance()
            };
            
            // Add these metrics to the dashboard UI
        }
        
        // 5.4 Avoid Account Bans & Limitations
        function implementAccountSafetyMeasures() {
            // Randomize posting times with safety settings
            function applyRandomizedTiming(scheduledTime) {
                const safetySettings = currentUserData.safetySettings || {};
                
                if (safetySettings.randomizeTime) {
                    // Add random delay between 1-5 minutes
                    const randomDelay = Math.floor(Math.random() * 5 * 60 * 1000) + 60000;
                    return new Date(scheduledTime.getTime() + randomDelay);
                }
                
                return scheduledTime;
            }
            
            // Avoid identical content across platforms
            function diversifyContentAcrossPlatforms(content, platform) {
                // Platform-specific content adjustments
                const platformModifications = {
                    facebook: { maxLength: 5000, hashtags: 3 },
                    instagram: { maxLength: 2200, hashtags: 10 },
                    twitter: { maxLength: 280, hashtags: 2 },
                    linkedin: { maxLength: 3000, hashtags: 5 }
                };
                
                const settings = platformModifications[platform] || { maxLength: 2000, hashtags: 5 };
                
                // Truncate content if needed
                if (content.length > settings.maxLength) {
                    content = content.substring(0, settings.maxLength - 3) + '...';
                }
                
                return content;
            }
            
            // Implement posting schedule that respects platform limits
            function createPlatformSafeSchedule(platform, numberOfPosts) {
                const platformLimits = {
                    facebook: 10, // posts per day
                    instagram: 3, // posts per day
                    twitter: 50,  // tweets per day
                    linkedin: 20   // posts per day
                };
                
                const dailyLimit = platformLimits[platform] || 5;
                return Math.min(numberOfPosts, dailyLimit);
            }
        }

        // ===== 6. BUG FIXES & PERFORMANCE OPTIMIZATIONS =====
        
        // 6.1 Fix Security: Database Permission Validation
        function setupFirebaseSecurityRules() {
            // This would be implemented in Firebase console, but we add client-side validation
            function validateUserAccess(resourceUserId) {
                if (userId !== resourceUserId) {
                    console.error('Security violation: User attempted to access unauthorized resource');
                    throw new Error('Unauthorized access attempt');
                }
            }
            
            // Apply to all database operations
            const originalUpdateDoc = updateDoc;
            updateDoc = async (docRef, data) => {
                // Validate document path contains the correct user ID
                if (docRef.path.includes('/users/') && !docRef.path.includes(`/users/${userId}`)) {
                    validateUserAccess(docRef.path.split('/users/')[1].split('/')[0]);
                }
                return originalUpdateDoc(docRef, data);
            };
            
            // Similar validation for other operations (getDoc, deleteDoc, etc.)
        }
        
        // 6.2 Fix Memory Leaks: Proper Listener Management
        function unsubscribeAllListeners() {
            unsubscribeListeners.forEach(unsubscribe => {
                try {
                    unsubscribe();
                } catch (error) {
                    console.warn('Error unsubscribing listener:', error);
                }
            });
            unsubscribeListeners = [];
        }
        
        // 6.3 Fix Chart Memory Leaks
        function destroyAllCharts() {
            Object.values(charts).forEach(chart => {
                try {
                    chart.destroy();
                } catch (error) {
                    console.warn('Error destroying chart:', error);
                }
            });
            charts = {};
        }
        
        // 6.4 Implement Pagination
        async function fetchPostsWithPagination(page, pageSize = 10) {
            try {
                let postsQuery = query(
                    collection(db, `/artifacts/${appId}/users/${userId}/posts`),
                    orderBy('createdAt', 'desc'),
                    limit(pageSize)
                );
                
                if (page > 1 && postsPagination.lastVisible) {
                    postsQuery = query(
                        collection(db, `/artifacts/${appId}/users/${userId}/posts`),
                        orderBy('createdAt', 'desc'),
                        startAfter(postsPagination.lastVisible),
                        limit(pageSize)
                    );
                }
                
                const snapshot = await getDocs(postsQuery);
                const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update pagination state
                postsPagination = {
                    currentPage: page,
                    pageSize,
                    totalPosts: await getTotalPostsCount(),
                    lastVisible: snapshot.docs[snapshot.docs.length - 1],
                    firstVisible: snapshot.docs[0]
                };
                
                return posts;
            } catch (error) {
                console.error('Error fetching posts with pagination:', error);
                throw error;
            }
        }
        
        async function getTotalPostsCount() {
            const snapshot = await getCountFromServer(
                collection(db, `/artifacts/${appId}/users/${userId}/posts`)
            );
            return snapshot.data().count;
        }
        
        // 6.5 Improved Theme Management
        function setupEnhancedThemeManagement() {
            const themeSwitch = document.getElementById('themeSwitch');
            const themeIcon = themeSwitch.querySelector('i');
            
            // Load saved theme or detect system preference
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
                themeIcon.className = 'fas text-xl fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.className = 'fas text-xl fa-moon';
                localStorage.setItem('theme', 'light');
            }
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        document.documentElement.classList.add('dark');
                        themeIcon.className = 'fas text-xl fa-sun';
                    } else {
                        document.documentElement.classList.remove('dark');
                        themeIcon.className = 'fas text-xl fa-moon';
                    }
                }
            });
        }
        
        // 6.6 Mobile Responsiveness Improvements
        function setupMobileUI() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            function openMobileSidebar() {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
            
            function closeMobileSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
                document.body.style.overflow = '';
            }
            
            mobileMenuBtn.addEventListener('click', openMobileSidebar);
            sidebarOverlay.addEventListener('click', closeMobileSidebar);
            
            // Handle keyboard navigation for accessibility
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    closeMobileSidebar();
                }
            });
        }
        
        // 6.7 Comprehensive Error Handling
        function setupGlobalErrorHandling() {
            // Global error handler
            window.addEventListener('error', (e) => {
                console.error('Global error:', e.error);
                showToast('خطأ', 'حدث خطأ غير متوقع في التطبيق.', 'error');
            });
            
            // Unhandled promise rejection handler
            window.addEventListener('unhandledrejection', (e) => {
                console.error('Unhandled promise rejection:', e.reason);
                showToast('خطأ', 'حدث خطأ في معالجة البيانات.', 'error');
                e.preventDefault();
            });
            
            // Wrap all event listeners with error handling
            const originalAddEventListener = EventTarget.prototype.addEventListener;
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                const wrappedListener = function(...args) {
                    try {
                        return listener.apply(this, args);
                    } catch (error) {
                        console.error(`Error in event listener for ${type}:`, error);
                        showToast('خطأ', 'حدث خطأ في معالجة الإجراء.', 'error');
                    }
                };
                
                return originalAddEventListener.call(this, type, wrappedListener, options);
            };
        }
        
        // 6.8 Code Reuse & Helper Functions
        function createHelperFunctions() {
            // Debounce function for performance
            window.debounce = function(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };
            
            // Format numbers in Arabic
            window.formatNumber = function(num) {
                return new Intl.NumberFormat('ar-EG').format(num);
            };
            
            // Safe data access
            window.getSafe = function(obj, path, defaultValue = null) {
                return path.split('.').reduce((acc, part) => acc && acc[part], obj) || defaultValue;
            };
        }
        
        // 6.9 Clear Data on Logout
        function clearAppDataOnLogout() {
            // Clear all app-related data from localStorage
            const keysToKeep = ['theme']; // Keep theme preference
            Object.keys(localStorage).forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            // Clear sessionStorage
            sessionStorage.clear();
            
            // Clear any cached data
            if (window.caches) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        caches.delete(cacheName);
                    });
                });
            }
            
            // Clear variables
            currentUserData = null;
            userId = null;
            allUserPosts = [];
            userAccounts = [];
            userAutomations = [];
            allConversations = [];
            
            // Destroy all charts
            destroyAllCharts();
            
            // Unsubscribe all listeners
            unsubscribeAllListeners();
            
            // Clear any intervals
            if (postCheckIntervalId) {
                clearInterval(postCheckIntervalId);
                postCheckIntervalId = null;
            }
        }
        
        // 6.10 Virtual List for Performance
        function setupVirtualList(containerId, items, itemRenderer, itemHeight = 60) {
            const container = document.getElementById(containerId);
            const containerHeight = container.clientHeight;
            const visibleItemCount = Math.ceil(containerHeight / itemHeight);
            
            virtualListState = {
                visibleStartIndex: 0,
                visibleEndIndex: visibleItemCount,
                itemHeight,
                containerHeight
            };
            
            function updateVisibleItems() {
                const scrollTop = container.scrollTop;
                const startIndex = Math.floor(scrollTop / itemHeight);
                const endIndex = Math.min(startIndex + visibleItemCount + 2, items.length);
                
                if (startIndex !== virtualListState.visibleStartIndex || 
                    endIndex !== virtualListState.visibleEndIndex) {
                    
                    virtualListState.visibleStartIndex = startIndex;
                    virtualListState.visibleEndIndex = endIndex;
                    
                    // Clear container
                    container.innerHTML = '';
                    
                    // Set container height for scroll
                    container.style.height = `${items.length * itemHeight}px`;
                    
                    // Create visible items
                    const fragment = document.createDocumentFragment();
                    for (let i = startIndex; i < endIndex; i++) {
                        const item = items[i];
                        const itemElement = document.createElement('div');
                        itemElement.className = 'virtual-item';
                        itemElement.style.top = `${i * itemHeight}px`;
                        itemElement.style.height = `${itemHeight}px`;
                        itemElement.innerHTML = itemRenderer(item, i);
                        fragment.appendChild(itemElement);
                    }
                    
                    container.appendChild(fragment);
                }
            }
            
            // Initial render
            updateVisibleItems();
            
            // Add scroll listener with debounce
            container.addEventListener('scroll', debounce(updateVisibleItems, 50));
            
            // Handle resize
            window.addEventListener('resize', debounce(() => {
                virtualListState.containerHeight = container.clientHeight;
                virtualListState.visibleItemCount = Math.ceil(container.clientHeight / itemHeight);
                updateVisibleItems();
            }, 250));
        }

        // ===== 7. ACCESSIBILITY IMPROVEMENTS =====
        function enhanceAccessibility() {
            // Add ARIA attributes to dynamic content
            function initARIA() {
                // Main navigation
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach((link, index) => {
                    link.setAttribute('role', 'menuitem');
                    link.setAttribute('aria-label', link.querySelector('.text').textContent);
                    if (link.classList.contains('active')) {
                        link.setAttribute('aria-current', 'page');
                    }
                });
                
                // Modal dialog
                const modal = document.getElementById('mainModal');
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-labelledby', 'modalTitle');
                modal.setAttribute('aria-modal', 'true');
                
                // Charts
                const charts = document.querySelectorAll('canvas');
                charts.forEach((chart, index) => {
                    chart.setAttribute('role', 'img');
                    chart.setAttribute('aria-label', `مخطط بياني ${index + 1}`);
                });
            }
            
            // Keyboard navigation
            function setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Close modal with Escape
                    if (e.key === 'Escape' && !document.getElementById('mainModal').classList.contains('hidden')) {
                        hideModal();
                    }
                    
                    // Navigate menus with arrow keys
                    if (e.target.matches('[role="menuitem"]')) {
                        const menuItems = Array.from(document.querySelectorAll('[role="menuitem"]'));
                        const currentIndex = menuItems.indexOf(e.target);
                        
                        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                            e.preventDefault();
                            const nextIndex = (currentIndex + 1) % menuItems.length;
                            menuItems[nextIndex].focus();
                        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            const prevIndex = (currentIndex - 1 + menuItems.length) % menuItems.length;
                            menuItems[prevIndex].focus();
                        }
                    }
                });
            }
            
            // Focus management for modals
            function setupFocusManagement() {
                let previousActiveElement = null;
                
                const originalShowModal = window.showModal;
                window.showModal = function(content) {
                    previousActiveElement = document.activeElement;
                    originalShowModal(content);
                    
                    // Focus on first focusable element in modal
                    const focusableElements = document.getElementById('mainModalContent').querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                    
                    // Trap focus inside modal
                    document.addEventListener('keydown', trapFocus);
                };
                
                const originalHideModal = window.hideModal;
                window.hideModal = function() {
                    originalHideModal();
                    document.removeEventListener('keydown', trapFocus);
                    
                    // Return focus to previous element
                    if (previousActiveElement) {
                        previousActiveElement.focus();
                    }
                };
                
                function trapFocus(e) {
                    if (e.key !== 'Tab') return;
                    
                    const modal = document.getElementById('mainModalContent');
                    if (modal.classList.contains('hidden')) return;
                    
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            }
            
            // Initialize all accessibility features
            initARIA();
            setupKeyboardNavigation();
            setupFocusManagement();
        }

        // ===== 8. INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setupSections();
                setupEnhancedThemeManagement();
                setupMobileUI();
                setupGlobalErrorHandling();
                createHelperFunctions();
                enhanceAccessibility();
                setupFirebaseSecurityRules();
                setupCronJobSystem();
                
                // Attempt sign in if token exists
                attemptSignIn();
                
                // Set up event listeners
                document.getElementById('googleLoginBtn').addEventListener('click', () => {
                    signInWithPopup(auth, new GoogleAuthProvider()).catch(error => {
                        console.error("Google sign in error:", error);
                        showToast('خطأ', 'فشل تسجيل الدخول باستخدام جوجل.', 'error');
                    });
                });
                
                ['logoutBtn', 'logoutBtnDropdown'].forEach(id => {
                    document.getElementById(id).addEventListener('click', () => {
                        clearAppDataOnLogout();
                        signOut(auth).catch(error => {
                            console.error("Sign out error:", error);
                        });
                    });
                });
                
                document.getElementById('sidebar').addEventListener('click', (e) => { 
                    const link = e.target.closest('a[data-section]'); 
                    if (link) { 
                        e.preventDefault(); 
                        navigateToSection(link.dataset.section); 
                    } 
                });
                
                const themeSwitch = document.getElementById('themeSwitch');
                const themeIcon = themeSwitch.querySelector('i');
                
                themeSwitch.addEventListener('click', () => { 
                    document.documentElement.classList.toggle('dark'); 
                    const isDark = document.documentElement.classList.contains('dark');
                    themeIcon.className = `fas text-xl ${isDark ? 'fa-sun' : 'fa-moon'}`;
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });
                
                const userMenuButton = document.getElementById('user-menu-button');
                const userMenu = document.getElementById('user-menu');
                
                userMenuButton.addEventListener('click', () => {
                    userMenu.classList.toggle('hidden');
                });
                
                document.addEventListener('click', (e) => { 
                    if (!document.getElementById('user-menu-container').contains(e.target)) {
                        userMenu.classList.add('hidden');
                    }
                });

                document.getElementById('mainModal').addEventListener('click', e => {
                    if (e.target.id === 'mainModal') {
                        hideModal();
                    }
                });
                
            } catch (error) {
                console.error("Error during initialization:", error);
                showToast('خطأ', 'حدث خطأ أثناء تهيئة التطبيق.', 'error');
            }
        });

        // ===== 9. AUTH STATE MANAGEMENT =====
        onAuthStateChanged(auth, async (user) => {
            showLoader();
            try {
                if (user) {
                    userId = user.uid;
                    const userRef = doc(db, `/artifacts/${appId}/users`, user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (!userDoc.exists()) {
                        const newUser = { 
                            name: user.displayName, 
                            email: user.email, 
                            avatar: user.photoURL, 
                            createdAt: serverTimestamp(), 
                            role: 'user', 
                            workspaceName: `${user.displayName}'s Workspace`, 
                            safetySettings: {randomizeTime: true}, 
                            initialFollowers: Math.floor(Math.random() * 500) + 500 
                        };
                        await setDoc(userRef, newUser); 
                        currentUserData = newUser;
                    } else { 
                        currentUserData = { id: userDoc.id, ...userDoc.data() }; 
                    }
                    
                    initializeAppForUser();
                } else {
                    if (postCheckIntervalId) clearInterval(postCheckIntervalId);
                    unsubscribeAllListeners();
                    document.getElementById('authContainer').classList.remove('hidden'); 
                    document.getElementById('appContainer').classList.add('hidden');
                    hideLoader();
                }
            } catch (error) {
                console.error("Error in auth state change:", error);
                showToast('خطأ', 'حدث خطأ أثناء تحميل بيانات المستخدم.', 'error');
                hideLoader();
            }
        });

        function initializeAppForUser() {
            try {
                if (postCheckIntervalId) clearInterval(postCheckIntervalId);
                unsubscribeAllListeners();
                
                updateUIForUser();
                attachRealtimeListeners();
                startPostScheduler();

                const adminLink = document.getElementById('admin-nav-link');
                if(currentUserData.role === 'admin') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }

                document.getElementById('authContainer').classList.add('hidden'); 
                document.getElementById('appContainer').classList.remove('hidden');
                navigateToSection('dashboard');
                hideLoader();
            } catch (error) {
                console.error("Error initializing app for user:", error);
                showToast('خطأ', 'حدث خطأ أثناء تهيئة التطبيق للمستخدم.', 'error');
                hideLoader();
            }
        }

        // Service Worker for Background Tasks (Cron Jobs)
        if ('serviceWorker' in navigator) {
            // Register service worker
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        }

    </script>
</body>
</html>